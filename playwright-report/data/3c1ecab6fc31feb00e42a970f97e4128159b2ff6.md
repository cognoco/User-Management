# Test info

- Name: Registration End-to-End Flow >> should show error when registering business account with existing personal email
- Location: C:\Dev\Projects\Products\Apps\user-management-reorganized\e2e\auth\personal\registration.spec.ts:1373:3

# Error details

```
Error: page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/auth/register
Call log:
  - navigating to "http://localhost:3000/auth/register", waiting until "load"

    at C:\Dev\Projects\Products\Apps\user-management-reorganized\e2e\auth\personal\registration.spec.ts:1381:16
```

# Test source

```ts
  1281 |               checkbox.dispatchEvent(new Event('change', { bubbles: true }));
  1282 |             }
  1283 |           });
  1284 |           await page.waitForTimeout(500);
  1285 |         } catch (error3) {
  1286 |           console.log('Could not check terms and conditions');
  1287 |         }
  1288 |       }
  1289 |     }
  1290 |
  1291 |     // Submit the form
  1292 |     if (isFirefox) {
  1293 |       // Enhanced submit for Firefox
  1294 |       await page.click('h1:has-text("Create Your Account")');
  1295 |       await page.waitForTimeout(1000);
  1296 |       for (const fieldId of [
  1297 |         'email-input',
  1298 |         'first-name-input',
  1299 |         'last-name-input',
  1300 |         'password-input',
  1301 |         'confirm-password-input',
  1302 |         'company-name-input',
  1303 |       ]) {
  1304 |         await page.click(`[data-testid="${fieldId}"]`);
  1305 |         await page.keyboard.press('Tab');
  1306 |         await page.waitForTimeout(300);
  1307 |       }
  1308 |       for (const selector of ['button[type="submit"]', '[data-testid="submit-button"]', 'button:has-text("Register")']) {
  1309 |         try {
  1310 |           await page.click(selector, { force: true, timeout: 3000 });
  1311 |           break;
  1312 |         } catch (error) {
  1313 |           console.log(`Failed to click submit button: ${selector}`);
  1314 |         }
  1315 |       }
  1316 |       await page.evaluate(() => {
  1317 |         const form = document.querySelector('form') as HTMLFormElement;
  1318 |         if (form) form.submit();
  1319 |       });
  1320 |     } else {
  1321 |       try {
  1322 |         await page.waitForSelector('button[type="submit"]:not([disabled]), [data-testid="submit-button"]:not([disabled])', { timeout: 10000 });
  1323 |       } catch (error) {
  1324 |         console.log('Submit button not found in enabled state, attempting to submit anyway');
  1325 |       }
  1326 |       await page.locator('button[type="submit"]').click({ force: true, timeout: 5000 });
  1327 |     }
  1328 |
  1329 |     // Wait for either success message or redirection
  1330 |     await page.waitForTimeout(3000);
  1331 |
  1332 |     // Assert on success message or redirection
  1333 |     let foundSuccess = false;
  1334 |     try {
  1335 |       await page.waitForSelector('[role="alert"]', { timeout: 3000 });
  1336 |       const successMessage = await page.locator('[role="alert"]').isVisible();
  1337 |       if (successMessage) {
  1338 |         foundSuccess = true;
  1339 |         await expect(page.locator('[role="alert"]').filter({ hasText: /success|check your email|verify/i })).toBeVisible();
  1340 |       }
  1341 |     } catch (error) {
  1342 |       // Fallback: check for check-email redirect
  1343 |       console.log('No visible success alert, checking for redirect');
  1344 |     }
  1345 |
  1346 |     const currentUrl = page.url();
  1347 |     if (currentUrl.includes('check-email')) {
  1348 |       foundSuccess = true;
  1349 |       expect(currentUrl).toMatch(/check-email/i);
  1350 |       expect(currentUrl).toContain(encodeURIComponent(uniqueEmail));
  1351 |       try {
  1352 |         await expect(page.getByText(/verify|email|sent|confirmation/i)).toBeVisible({ timeout: 3000 });
  1353 |       } catch (error) {
  1354 |         console.log('No visible verification text on check-email page');
  1355 |       }
  1356 |     }
  1357 |
  1358 |     if (!foundSuccess) {
  1359 |       // Fallback: check for any success indicator in page content
  1360 |       try {
  1361 |         const pageContent = await page.content();
  1362 |         if (pageContent.match(/success|registered|verification|check your email/i)) {
  1363 |           foundSuccess = true;
  1364 |         }
  1365 |       } catch (error) {
  1366 |         console.log('Could not check page content for success indicator');
  1367 |       }
  1368 |     }
  1369 |
  1370 |     expect(foundSuccess).toBeTruthy();
  1371 |   });
  1372 |
  1373 |   test('should show error when registering business account with existing personal email', async ({ page, browserName }) => {
  1374 |     // Skip for Safari as it has timing issues
  1375 |     if (browserName === 'webkit') {
  1376 |       test.skip(true, 'Test is unstable in Safari - skipping');
  1377 |       return;
  1378 |     }
  1379 |
  1380 |     // Navigate to registration page
> 1381 |     await page.goto('/auth/register', { timeout: 10000 });
       |                ^ Error: page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/auth/register
  1382 |     await page.waitForSelector('[data-testid="registration-form"]', { state: 'visible', timeout: 10000 });
  1383 |
  1384 |     // Setup: First ensure we're in business registration mode
  1385 |     const userTypeRadioGroup = page.locator('[data-testid="user-type-radio-group"]');
  1386 |     if (await userTypeRadioGroup.isVisible({ timeout: 3000 }).catch(() => false)) {
  1387 |       // Select business/corporate user type
  1388 |       await page.click('[data-testid="user-type-corporate"]', { force: true, timeout: 3000 }).catch(async () => {
  1389 |         // Fall back to alternative selectors if needed
  1390 |         await page.click('input[value="corporate"]', { force: true, timeout: 3000 }).catch(async () => {
  1391 |           // Use JavaScript as last resort
  1392 |           await page.evaluate(() => {
  1393 |             const radio = document.querySelector('input[value="corporate"]') as HTMLInputElement;
  1394 |             if (radio) {
  1395 |               radio.checked = true;
  1396 |               radio.dispatchEvent(new Event('change', { bubbles: true }));
  1397 |             }
  1398 |           });
  1399 |         });
  1400 |       });
  1401 |       await page.waitForTimeout(500);
  1402 |     }
  1403 |
  1404 |     // Make sure company field is visible (confirms business mode)
  1405 |     const companyNameField = page.locator('[data-testid="company-name-input"]');
  1406 |     await companyNameField.isVisible({ timeout: 3000 }).catch(() => {
  1407 |       console.log('Company field not visible - test may not be reliable');
  1408 |     });
  1409 |
  1410 |     // Use an email that we'll mock as already existing in personal accounts
  1411 |     const existingEmail = 'existing.personal@example.com';
  1412 |     
  1413 |     // Fill out the business registration form
  1414 |     await page.fill('[data-testid="email-input"]', existingEmail);
  1415 |     await page.fill('[data-testid="password-input"]', 'TestPassword123!');
  1416 |     await page.fill('[data-testid="confirm-password-input"]', 'TestPassword123!');
  1417 |     await page.fill('[data-testid="first-name-input"]', 'Test');
  1418 |     await page.fill('[data-testid="last-name-input"]', 'User');
  1419 |     await page.fill('[data-testid="company-name-input"]', 'Test Company');
  1420 |     
  1421 |     // Fill required business fields
  1422 |     await page.fill('[data-testid="city-input"]', 'Test City').catch(() => console.log('City field not found'));
  1423 |     await page.fill('[data-testid="state-input"]', 'Test State').catch(() => console.log('State field not found'));
  1424 |     await page.fill('[data-testid="contact-email-input"]', 'contact@testcompany.com').catch(() => console.log('Contact email field not found'));
  1425 |     await page.fill('[data-testid="contact-phone-input"]', '1234567890').catch(() => console.log('Contact phone field not found'));
  1426 |     
  1427 |     // Select company size and industry if dropdowns exist
  1428 |     await page.selectOption('[data-testid="company-size-select"]', '11-50').catch(() => console.log('Company size dropdown not found'));
  1429 |     await page.selectOption('[data-testid="industry-select"]', 'Technology').catch(() => console.log('Industry dropdown not found'));
  1430 |     
  1431 |     // Accept terms
  1432 |     await page.check('[data-testid="terms-checkbox"]').catch(async () => {
  1433 |       try {
  1434 |         await page.click('[data-testid="terms-label"]', { force: true });
  1435 |       } catch {
  1436 |         await page.evaluate(() => {
  1437 |           const checkbox = document.querySelector('[data-testid="terms-checkbox"]') as HTMLInputElement;
  1438 |           if (checkbox) {
  1439 |             checkbox.checked = true;
  1440 |             checkbox.dispatchEvent(new Event('change', { bubbles: true }));
  1441 |           }
  1442 |         });
  1443 |       }
  1444 |     });
  1445 |     
  1446 |     // Mock the API response for an existing personal account
  1447 |     await page.route('**/api/auth/register', async (route) => {
  1448 |       await route.fulfill({
  1449 |         status: 400,
  1450 |         contentType: 'application/json',
  1451 |         body: JSON.stringify({
  1452 |           error: 'email_exists_personal',
  1453 |           message: 'An account with this email already exists as a personal account.'
  1454 |         })
  1455 |       });
  1456 |     });
  1457 |     
  1458 |     // Submit the form
  1459 |     await page.click('button[type="submit"]');
  1460 |     
  1461 |     // Check for the appropriate error message about existing personal account
  1462 |     await expect(page.locator('[role="alert"]')).toContainText(/already exists as a personal account|upgrade to business/i, { timeout: 5000 });
  1463 |     
  1464 |     // Check if there's an upgrade link
  1465 |     const upgradeLink = page.locator('a:has-text("Upgrade to Business Account")');
  1466 |     await upgradeLink.isVisible().then(visible => {
  1467 |       if (visible) {
  1468 |         console.log('Upgrade link is visible as expected');
  1469 |       } else {
  1470 |         console.log('Upgrade link not found - may need implementation');
  1471 |       }
  1472 |     });
  1473 |   });
  1474 |
  1475 |   test('should handle all company size and industry options including "Other"', async ({ page, browserName }) => {
  1476 |     // Skip for Safari as it has timing issues
  1477 |     if (browserName === 'webkit') {
  1478 |       test.skip(true, 'Test is unstable in Safari - skipping');
  1479 |       return;
  1480 |     }
  1481 |
```